<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My 3D Function Plotter</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        #functionInput {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }
    </style>
    <script src="nerdamer/nerdamer.core.js"></script>
    <script src="nerdamer/Algebra.js"></script>
    <script src="nerdamer/Extra.js"></script>
    <script src="nerdamer/Calculus.js"></script>
    <script src="nerdamer/Solve.js"></script>
</head>
<body>
    <input id="functionInput" type="text" placeholder="Enter a function (e.g., sin(x), x^2)" />
    <a-scene background="color: #ECECEC">
        <a-camera position="0 0 5"wasd-controls="acceleration: 10"></a-camera>
    </a-scene>

    <script>
        document.getElementById('functionInput').addEventListener('change', function(event) {
            let functionText = event.target.value;
            try {
                console.log("Parsing function: ", functionText)
                if (!functionText.includes('=') && (functionText.includes('x') || functionText.includes('y'))) {
                    if (functionText.includes('x')) {
                        functionText += '=y';
                    } else if (functionText.includes('y')) {
                        functionText += '=x';
                    }
                }
                const expr = nerdamer(functionText);
                console.log("Parsed expression: ", expr);
                updateGraph(expr);
            } catch (error) {
                console.error('Error parsing function. Please check the syntax.\n', error);
            }
        });

        function drawAxes() {
            const sceneEl = document.querySelector('a-scene');
            const axisLength = 5;
            createAxisLine(sceneEl, {x: -axisLength, y: 0, z: 0}, {x: axisLength, y: 0, z: 0}, 'red');
            createAxisLine(sceneEl, {x: 0, y: -axisLength, z: 0}, {x: 0, y: axisLength, z: 0}, 'green');
            createAxisLine(sceneEl, {x: 0, y: 0, z: -axisLength}, {x: 0, y: 0, z: axisLength}, 'blue');
        }
    
        function createAxisLine(sceneEl, start, end, color) {
            const posX = (start.x + end.x) / 2;
            const posY = (start.y + end.y) / 2;
            const posZ = (start.z + end.z) / 2;
            const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2) + Math.pow(end.z - start.z, 2));

            let rotationX, rotationY, rotationZ;

            rotationX = -Math.atan2(end.z - start.z, Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2))) * (180 / Math.PI);
            rotationY = 0;
            rotationZ = -Math.atan2(end.x - start.x, end.y - start.y) * (180 / Math.PI);

            const axisEl = document.createElement('a-cylinder');
            axisEl.setAttribute('radius', '0.01');
            axisEl.setAttribute('height', length);
            axisEl.setAttribute('color', color);
            axisEl.setAttribute('position', `${posX} ${posY} ${posZ}`);
            axisEl.setAttribute('rotation', `${rotationX} ${rotationY} ${rotationZ}`);
            sceneEl.appendChild(axisEl);
        }

        function addAxisLabels() {
            const sceneEl = document.querySelector('a-scene');
            createAxisLabel(sceneEl, 'X', {x: 2.2, y: 0, z: 0});
            createAxisLabel(sceneEl, 'Y', {x: 0, y: 2.2, z: 0.05});
            createAxisLabel(sceneEl, 'Z', {x: 0, y: 0, z: 2.2});
        }

        function createAxisLabel(sceneEl, text, position) {
            const textEl = document.createElement('a-text');
            textEl.setAttribute('value', text);
            textEl.setAttribute('color', 'black');
            textEl.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            textEl.setAttribute('align', 'center');
            sceneEl.appendChild(textEl);
        }
        
        const radToDeg = 180 / Math.PI;
        function updateGraph(expr) {
            const sceneEl = document.querySelector('a-scene');
            const previousLines = sceneEl.querySelectorAll('.graph-line');
            previousLines.forEach(line => line.parentNode.removeChild(line));

            for (let x = -5; x < 5; x += 0.01) {
                let y1 = nerdamer(expr.sub('x', x)).solveFor('y');
                let y2 = nerdamer(expr.sub('x', x + 0.005)).solveFor('y');

                if (!Array.isArray(y1)) y1 = [y1];
                if (!Array.isArray(y2)) y2 = [y2];

                // Evaluate all the expressions in the arrays
                for(let i = 0; i < y1.length; i++) {
                    y1[i] = nerdamer(y1[i]).evaluate();
                }
                for(let i = 0; i < y2.length; i++) {
                    y2[i] = nerdamer(y2[i]).evaluate();
                }
                if(y1.length > y2.length) {
                    for (let i = 0; i < y1.length; i++) {
                        const currentY1 = y1[i];
                        // Set currentY2 to the closest value to currentY1 in the y2 array
                        let currentY2 = y2[0];
                        var minDiff = 999999;
                        for(let j = 0; j < y2.length; j++) {
                            const diff = Math.abs(y2[j] - currentY1);
                            if (diff < minDiff) {
                                minDiff = diff;
                                currentY2 = y2[j];
                                // Remove the value from the array so that it is not used again
                                // y2.splice(j, 1);
                                if(minDiff > 0.0051) {
                                    console.log("Min diff: ", minDiff, "currentY2: ", currentY2, "currentY1: ", currentY1);
                                }
                            }
                        }

                        const lineEl = document.createElement('a-entity');

                        const midX = x + 0.0025;
                        const midY = (currentY1 + currentY2) / 2;
                        const length = Math.sqrt(Math.pow(0.005, 2) + Math.pow(currentY2 - currentY1, 2));
                        const angle = Math.atan2(currentY2 - currentY1, 0.005) * radToDeg;

                        lineEl.setAttribute('geometry', {
                            primitive: 'box',
                            depth: 0.01,
                            height: 0.01,
                            width: length
                        });
                        lineEl.setAttribute('material', { color: 'red' });
                        lineEl.setAttribute('position', `${midX} ${midY} 0`);
                        lineEl.setAttribute('rotation', `0 0 ${angle}`);
                        lineEl.classList.add('graph-line');
                        sceneEl.appendChild(lineEl);
                        console.log("Added line at x=", x, "y1=", currentY1, "y2=", currentY2);
                    }
                } else {
                    for (let i = 0; i < y2.length; i++) {
                        const currentY2 = y2[i];
                        // Set currentY1 to the closest value to currentY1 in the y2 array
                        let currentY1 = y1[0];
                        var minDiff = 999999;
                        for(let j = 0; j < y1.length; j++) {
                            const diff = Math.abs(y1[j] - currentY2);
                            if (diff < minDiff) {
                                minDiff = diff;
                                currentY1 = y1[j];
                                // Remove the value from the array so that it is not used again
                                // y1.splice(j, 1);
                                if(minDiff > 0.0051) {
                                    console.log("Min diff: ", minDiff, "currentY1: ", currentY1, "currentY2: ", currentY2);
                                }
                            }
                        }

                        const lineEl = document.createElement('a-entity');

                        const midX = x + 0.0025;
                        const midY = (currentY1 + currentY2) / 2;
                        const length = Math.sqrt(Math.pow(0.005, 2) + Math.pow(currentY2 - currentY1, 2));
                        const angle = Math.atan2(currentY2 - currentY1, 0.005) * radToDeg;

                        lineEl.setAttribute('geometry', {
                            primitive: 'box',
                            depth: 0.01,
                            height: 0.01,
                            width: length
                        });
                        lineEl.setAttribute('material', { color: 'red' });
                        lineEl.setAttribute('position', `${midX} ${midY} 0`);
                        lineEl.setAttribute('rotation', `0 0 ${angle}`);
                        lineEl.classList.add('graph-line');
                        sceneEl.appendChild(lineEl);
                        console.log("Added line at x=", x, "y1=", currentY1, "y2=", currentY2);
                    }
                }
            }
        }

        document.querySelector('a-scene').addEventListener('loaded', function() {
            drawAxes();
            addAxisLabels();
        });
    </script>
</body>
</html>
